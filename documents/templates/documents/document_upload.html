{% extends "base.html" %}

{% block title %}Upload Document{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-upload"></i> Upload Document</h3>
                </div>
                <div class="card-body">
                    <!-- Upload Form -->
                    <form id="uploadForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- File Upload Area -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Select File</strong></label>
                            <div class="border border-2 border-dashed rounded p-5 text-center"
                                 id="dropZone"
                                 ondrop="dropHandler(event);"
                                 ondragover="dragOverHandler(event);"
                                 ondragleave="dragLeaveHandler(event);">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                <h5>Drag and drop file here</h5>
                                <p class="text-muted">or</p>
                                <input type="file" class="form-control" id="fileInput" name="file"
                                       accept=".pdf,.docx,.xlsx,.pptx,.txt,.csv,.png,.jpg,.jpeg,.gif,.zip"
                                       required onchange="handleFileSelect(event)">
                            </div>
                            <div class="form-text">
                                <strong>Supported formats:</strong> PDF, Word, Excel, PowerPoint, Text, CSV, Images (PNG, JPG, GIF), ZIP
                                <br>
                                <strong>Maximum size:</strong> 5GB (varies by file type)
                            </div>
                        </div>

                        <!-- File Preview -->
                        <div id="filePreview" class="mb-4 d-none">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file fa-2x me-3"></i>
                                    <div class="flex-grow-1">
                                        <strong id="fileName"></strong>
                                        <br>
                                        <small id="fileSize" class="text-muted"></small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                        <i class="fas fa-times"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Document Details -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="title" class="form-label"><strong>Title</strong></label>
                                <input type="text" class="form-control" id="title" name="title"
                                       placeholder="Document title (auto-filled from filename)">
                                <div class="form-text">Leave blank to use the filename</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label"><strong>Description</strong> (optional)</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                      placeholder="Add a description for this document"></textarea>
                        </div>

                        <!-- Organization -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="category" class="form-label"><strong>Category</strong> (optional)</label>
                                <select class="form-select" id="category" name="category_id">
                                    <option value="">No Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <a href="{% url 'documents:category_list' %}" target="_blank">Manage categories</a>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label for="tags" class="form-label"><strong>Tags</strong> (optional)</label>
                                <input type="text" class="form-control" id="tags" name="tag_names"
                                       placeholder="tag1, tag2, tag3"
                                       data-role="tagsinput">
                                <div class="form-text">Separate tags with commas</div>
                            </div>
                        </div>

                        <!-- Compression Options -->
                        <div class="card mb-4 bg-light">
                            <div class="card-body">
                                <h6 class="mb-3">
                                    <i class="fas fa-compress"></i> Compression Options
                                </h6>
                                <p class="small text-muted mb-3">
                                    Documents are automatically compressed using intelligent algorithms to save storage space.
                                    The compression is lossless - your original file is preserved perfectly.
                                </p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoCompress" checked disabled>
                                    <label class="form-check-label" for="autoCompress">
                                        <strong>Automatic compression</strong> (recommended)
                                        <br>
                                        <small class="text-muted">Average space savings: 40-60% for documents</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Bar (shown during upload) -->
                        <div id="upload-progress" class="mb-3 d-none">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 100%">
                                    Uploading...
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'documents:dashboard' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-upload"></i> Upload Document
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Upload Info -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> What Happens Next?</h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li><strong>Upload:</strong> Your file is securely uploaded to the server</li>
                        <li><strong>Validation:</strong> File type and size are verified</li>
                        <li><strong>Compression:</strong> The file is automatically compressed in the background (if beneficial)</li>
                        <li><strong>Ready:</strong> Your document is available immediately, compression happens asynchronously</li>
                    </ol>
                    <div class="alert alert-success mt-3 mb-0">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Secure & Private:</strong> All uploads are encrypted and only you can access your documents.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Drag and drop handlers
function dragOverHandler(ev) {
    ev.preventDefault();
    document.getElementById('dropZone').classList.add('border-primary', 'bg-light');
}

function dragLeaveHandler(ev) {
    document.getElementById('dropZone').classList.remove('border-primary', 'bg-light');
}

function dropHandler(ev) {
    ev.preventDefault();
    document.getElementById('dropZone').classList.remove('border-primary', 'bg-light');

    if (ev.dataTransfer.items) {
        const file = ev.dataTransfer.items[0].getAsFile();
        const fileInput = document.getElementById('fileInput');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        handleFileSelect({ target: fileInput });
    }
}

// File selection handler
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        document.getElementById('filePreview').classList.remove('d-none');
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);

        // Auto-fill title if empty
        if (!document.getElementById('title').value) {
            const title = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
            document.getElementById('title').value = title;
        }
    }
}

// Clear file
function clearFile() {
    document.getElementById('fileInput').value = '';
    document.getElementById('filePreview').classList.add('d-none');
    document.getElementById('title').value = '';
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Show progress bar when form is submitted
document.getElementById('uploadForm').addEventListener('submit', function() {
    document.getElementById('upload-progress').classList.remove('d-none');
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
});
</script>
{% endblock %}
